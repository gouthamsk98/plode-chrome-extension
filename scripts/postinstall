#!/bin/bash

# Get the current user (the one running the installer)
CURRENT_USER=$(logname 2>/dev/null || echo $SUDO_USER)
if [ -z "$CURRENT_USER" ]; then
  CURRENT_USER=$(stat -f%Su /dev/console)
fi

USER_HOME=$(dscl . -read /Users/$CURRENT_USER NFSHomeDirectory | cut -d' ' -f2)
PLIST_PATH="/Library/LaunchAgents/com.plode_web_agent.daemon.plist"
USER_PLIST_PATH="$USER_HOME/Library/LaunchAgents/com.plode_web_agent.daemon.plist"

# Copy plist to user's LaunchAgents directory
mkdir -p "$USER_HOME/Library/LaunchAgents"
cp "$PLIST_PATH" "$USER_PLIST_PATH"
chown $CURRENT_USER:staff "$USER_PLIST_PATH"

# Load the LaunchAgent for the current user
sudo -u $CURRENT_USER launchctl load "$USER_PLIST_PATH"

# Enable it to start at login
sudo -u $CURRENT_USER launchctl enable "gui/$(id -u $CURRENT_USER)/com.plode_web_agent.daemon"

echo "âœ… plode_web_agent daemon has been installed and started"
exit 0
